# **TPS指标怎么定？** {#id-第二节指标怎么制定-TPS指标怎么定？}

TPS是评估系统处理能力重要的指标，当然TPS越大越好，但在实际项目中，综合时间成本、人力成本、技术成本考虑，需要把TPS定在合理的水平，以免造成过度优化或者指标预估不足。

**  
**

**已上线产品**  
对已上线产品，需要根据线上数据统计来确定QPS和RT指标  
数据统计有几种方式获得：通过我们的BI统计平台获取、或者通过哨兵监控获取。



公式: TPS = （峰值请求量 / 采集间隔）\* 集群数 \* 加权值



哨兵获取示例，music-homepage\_dg集群：

![](/assets/3-1.png)

由上图看，流量高峰期在晚上22:00，计算该点TPS

homepage 有两个集群（东冠、义桥），假如加权值为1.5，则目标TPS为

TPS = （86000 / 60）\* 2 \* 1.5 = 4300





**运营推广活动**

推广活动，一般流量比较集中，可以按照80/20 原则估算

80/20 原则说明：

理解一： 80%的业务量在20%的时间里完成  
理解二： 80%的访问请求，最终落在20%的数据上  
理解三： 80%的用户会在20%的时间内集中进行操作  
  


注意：

1. 80/20原则计算的是系统要达到的处理能力（吞吐量或者TPS），不是并发用户数。

2. 知道在线用户数或者注册用户数或者PV，就可用80/20原则预估出要达到的TPS。

   假设活动持续时间为T（单位为秒）  
   公式：TPS = PV\*80% / 3600\*T\*20%



根据云音乐用户特性，云音乐日常用户流量分布，可修正为60/40原则

例：智能红心歌单智能播放，预估日用户量4000w，日使用次数为1.5次，根据公式，计算TPS为

TPS = （4000w \* 0.6）/ （3600 \* 24 \* 0.4） \* 1.5 = 1041



比如，直播业务，国风盛典，运营给出来在线用户100w，怎么拆解这个指标呢？

根据业务场景，直播是有人进出的，假设直播存留率为50%，100w在线则需要200w人进入直播间，假设200w用户在5分钟内全部进入直播，根据80/20原则，目标TPS为

TPS = （200w \* 0.8）/ （60 \* 5 \* 0.2） = 2.67w



**新业务**

分析业务入口，参考同级页面相似接口线上数据，进行评估



换算公式：

![](/assets/3-2.png)

说明：P为加权值

**  
**

![](/assets/3-3.png)

**公式解释：**假设一个新业务有2个入口，入口一和入口二的调用曲线如图，则预期TPS 为SUM 曲线的最高点，即112.6 k

**  
**

**例： 智能播放业务**

![](/assets/3-4.png)



智能播放有2个入口，播放全部和播放单曲，分析这两个入口的线上数据，按照公式进行计算







**未上线的新产品**

* 对未上线产品的典型业务抽取可以参考同类已上线产品，比如nydus，可以参考同类的rocketMQ、kafka等，抽取典型的使用场景。
* 根据业务使用需求进行预估，底层服务预估时一定注意考虑业务增长性，使评估出的指标满足在业务增长下，2-3年后的业务量。



# 响应时间怎么定？ {#id-第二节指标怎么制定-响应时间怎么定？}

响应时间没有一个明确标准，要看业务形态、复杂度，比如用户的rpc接口响应时间在1ms左右，而推荐的rpc 接口在50ms，这个要结合业务去评估



* 我理解的云音乐2-5-8原则：

Web页面： 2s、5s、8s

http API：200ms、500ms、800ms

rpc API：20ms、50ms、80ms

cache:     2ms、5ms、8ms

DB：20ms、50ms、80ms





# 资源指标 {#id-第二节指标怎么制定-资源指标}

| 监控类型 | 监控指标 | 阈值 |
| :--- | :--- | :--- |
| 资源监控 | Load average | CPU核数\*2 |
|  | CPU利用率 | 80% |
|  | 系统内存使用（cache大小） | N/A |
|  | 磁盘Util% | 80% |
|  | 网络带宽 | 50% |
| 进程监控 | Younggc | Younggc频率不超过1s  Younggc时间不超过200ms |
|  | Fullgc | FullGC的频率不大于1小时，FullGC时间不超过2s。 |
|  | 线程状态 | 大量的线程blockedcurrentThreadsBusy监控 |
| 日志监控 | 错误日志 | 出现严重级别的Error或Exception |



